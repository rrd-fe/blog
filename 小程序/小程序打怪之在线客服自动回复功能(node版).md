### å‰è¨€
æˆ‘ä»¬çŸ¥é“H5é¡µé¢ç»å¸¸éœ€è¦å°†ç”¨æˆ·å¯¼æµåˆ°APPï¼Œé€šè¿‡ä¸‹è½½å®‰è£…åŒ…æˆ–è€…è·³è½¬è‡³åº”ç”¨å®å¸‚åœº/Appstoreç­‰æ–¹å¼è¿›è¡Œå¯¼æµã€‚ä½†æ˜¯ç”±äºå°ç¨‹åºåµŒå¥—webviewæ—¶éœ€è¦æ ¡éªŒåŸŸåï¼Œå› æ­¤è·³è½¬åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨å¸‚åœºå’ŒAppstroeæ— æ³•å®ç°å¯¼æµã€‚é‚£æ€ä¹ˆåŠå‘¢?
åªèƒ½è¯´é“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆï¼Œçœ‹çœ‹å¾®åšå°ç¨‹åºæ˜¯æ€ä¹ˆå¯¼æµçš„:

![01.gif](https://upload-images.jianshu.io/upload_images/97180-fcdfbd54e42667ad.gif?imageMogr2/auto-orient/strip)

æ›²çº¿æ•‘å›½çš„æ–¹å¼ï¼Œåˆ©ç”¨å°ç¨‹åºçš„åœ¨çº¿åŠŸèƒ½å¯ä»¥æ‰“å¼€H5çš„æ–¹å¼ï¼Œå»è¿›è¡Œä¸‹è½½å¼•å¯¼ã€‚
äºæ˜¯ï¼Œå°±å¼•å‡ºäº†è¿™æ¬¡æ–‡æ¡£çš„ä¸»é¢˜ï¼Œå°ç¨‹åºåœ¨çº¿å®¢æœè‡ªåŠ¨å›å¤åŠŸèƒ½ã€‚ğŸ˜†

é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œæœ€å¥½å·²ç»äº†è§£è¿‡å°ç¨‹åºå®¢æœä¿¡æ¯å®˜æ–¹çš„ç›¸å…³æ–‡æ¡£:

1.[å®¢æœæ¶ˆæ¯ä½¿ç”¨æŒ‡å—](https://developers.weixin.qq.com/miniprogram/introduction/custom.html)

2.[å°ç¨‹åºå®¢æœæ¶ˆæ¯æœåŠ¡ç«¯æ¥å£](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.setTyping.html)

3.[å®¢æœæ¶ˆæ¯å¼€å‘æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/customer-message/customer-message.html)

> è¿™æ¬¡å¼€å‘åšåœ¨çº¿å®¢æœåŠŸèƒ½ä¹Ÿè¸©äº†ä¸å°‘å‘ï¼Œç½‘ä¸Šä¹ŸæŸ¥é˜…ä¸å°‘èµ„æ–™ï¼Œä½†å¤§éƒ¨åˆ†çš„åå°éƒ½æ˜¯åŸºäºphpæˆ–è€…python,javaå¼€å‘ï¼Œnode.jså¼€å‘çš„è¾ƒå°‘ï¼Œå› æ­¤å°†è¿™æ¬¡å¼€å‘çš„æµç¨‹è®°å½•ä¸€ä¸‹ï¼Œä¾›å¤§å®¶å‚è€ƒï¼Œé¿å…å¤§å®¶è¸©å‘ã€‚å¯èƒ½ä¼šæœ‰ä¸€äº›é”™è¯¯åœ°æ–¹æ¬¢è¿æŒ‡æ­£äº¤æµã€‚
å¦å¤–ï¼Œæˆ‘ä»¬ç”¨çš„nodeæ¡†æ¶æ˜¯åŸºäºkoaè‡ªè¡Œå°è£…çš„ï¼Œåœ¨ä¸€äº›ç»†èŠ‚å®ç°ä¸Šå’Œå…¶ä»–æ¡†æ¶ä¼šæœ‰åŒºåˆ«ï¼Œä¸å¿…çº ç»“ã€‚

### éœ€æ±‚æè¿°
å°ç¨‹åºä¸­ç‚¹æŒ‰é’®è·³è½¬åœ¨çº¿å®¢æœç•Œé¢ï¼Œæ ¹æ®å…³é”®è¯è‡ªåŠ¨å›å¤
å®¢æœå›å¤åˆ¤æ–­æ¡ä»¶ï¼Œæ”¯æŒcmsé…ç½®keyï¼ŒåŠ respond 
respond æ”¯æŒé…ç½®ä»¥ä¸‹ç±»å‹ï¼ŒåŠå›å¤å†…å®¹:

type  | å†…å®¹
------------- | -------------
text  | text=æ–‡æœ¬å›å¤å†…å®¹
link  | title=æ ‡é¢˜  description=æè¿°  url=è·³è½¬é“¾æ¥ thumb_url=å›¾ç‰‡åœ°å€
image | imageurl=å›¾ç‰‡åœ°å€

* é…ç½®åç”¨æˆ·éœ€è¦ç²¾å‡†åŒ¹é…å›å¤æ¡ä»¶æ‰å¯æ”¶åˆ°è‡ªåŠ¨å›å¤
* å¯æ”¯æŒé…ç½®å¤šä¸ªkeyï¼ŒåŠå¯¹åº”respond
* é™¤äº†é…ç½®çš„keyä»¥å¤–çš„å›å¤ï¼Œå¯é…ç½®é»˜è®¤çš„è‡ªåŠ¨å›å¤

### å¼€å‘æµç¨‹
#### å†™ä¸ªè·³è½¬å®¢æœçš„æŒ‰é’®å§
index.wxml

```
<button open-type="contact">è½¬åœ¨çº¿å®¢æœ</button>
```
#### åå°é…ç½®
ç™»å½•[å°ç¨‹åºåå°](https://mp.weixin.qq.com/)åï¼Œåœ¨ã€Œå¼€å‘ã€-ã€Œå¼€å‘è®¾ç½®ã€-ã€Œæ¶ˆæ¯æ¨é€ã€ä¸­ï¼Œç®¡ç†å‘˜æ‰«ç å¯ç”¨æ¶ˆæ¯æœåŠ¡ï¼Œå¡«å†™æœåŠ¡å™¨åœ°å€ï¼ˆURLï¼‰ã€ä»¤ç‰Œï¼ˆTokenï¼‰ å’Œ æ¶ˆæ¯åŠ å¯†å¯†é’¥ï¼ˆEncodingAESKeyï¼‰ç­‰ä¿¡æ¯ã€‚
![o2.png](https://upload-images.jianshu.io/upload_images/97180-577fb7e44f426db5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. URLæœåŠ¡å™¨åœ°å€

> URL: å¼€å‘è€…ç”¨æ¥æ¥æ”¶å¾®ä¿¡æ¶ˆæ¯å’Œäº‹ä»¶çš„æ¥å£ URLã€‚å¼€å‘è€…æ‰€å¡«å†™çš„URL å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´ï¼Œåˆ†åˆ«æ”¯æŒ 80 ç«¯å£å’Œ 443 ç«¯å£ã€‚

åŠ¡å¿…è¦è®°ä½ï¼ŒæœåŠ¡å™¨åœ°å€å¿…é¡»æ˜¯**çº¿ä¸Š**åœ°å€ï¼Œå› ä¸ºéœ€è¦å¾®ä¿¡æœåŠ¡å™¨å»è®¿é—®ã€‚localhostï¼ŒIPï¼Œå†…ç½‘åœ°å€éƒ½ä¸è¡Œçš„ã€‚

ä¸ç„¶ä¼šæç¤º 'è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¿¡æ¯æ˜¯å¦å¡«å†™æ­£ç¡®'ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸åŒçš„å…¬å¸éƒ½æœ‰ä¸€å¥—ä¸Šçº¿æµç¨‹ï¼Œæ€»ä¸èƒ½ä¸ºäº†è°ƒè¯•URLæ˜¯å¦å¯ç”¨è¦ä¸Šåˆ°çº¿ä¸Šå»æµ‹è¯•ï¼Œæˆæœ¬å¤ªå¤§ï¼Œä¹Ÿä¸æ–¹ä¾¿ã€‚

è¿™å°±è¦å¼•å‡º**å†…ç½‘ç©¿é€**äº†ï¼Œç®€å•æ¥è¯´å°±æ˜¯é…ç½®ä¸€ä¸ªçº¿ä¸ŠåŸŸåï¼Œä½†æ˜¯è¿™ä¸ªåŸŸåå¯ä»¥ç©¿é€åˆ°ä½ é…ç½®çš„æœ¬åœ°å¼€å‘åœ°å€ä¸Šï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿ä½ å»è°ƒè¯•çœ‹æ—¥å¿—ã€‚
æ¨èä¸€ä¸ªå¯ä»¥å®ç°å†…ç½‘ç©¿é€çš„å·¥å…·ã€‚(éå¹¿å‘Š ğŸ˜†)

[NATAPP](https://natapp.cn/) å…·ä½“ä¸è¯¦ç»†ä»‹ç»ï¼Œå…å¾—å¹¿å‘Šå«Œç–‘ã€‚

ç®€å•è¯´ï¼ŒNATAPPæœ‰å…è´¹å’Œä»˜è´¹ä¸¤ç§æ¨¡å¼ï¼Œå…è´¹çš„æ˜¯åŸŸåä¸å®šæ—¶æ›´æ¢ï¼Œå¯¹äºå¾®ä¿¡çš„æ¨é€æ¶ˆæ¯é…ç½®ä¸€ä¸ªæœˆåªæœ‰3æ¬¡æ›´æ”¹æœºä¼šæ¥è¯´ï¼Œæœ‰ç‚¹å¥¢ä¾ˆã€‚ä¸å®šä»€ä¹ˆæ—¶å€™é…ç½®çš„åŸŸåå°±ä¸èƒ½è®¿é—®ï¼Œå¾—é‡æ–°é…ç½®ã€‚è€Œä»˜è´¹çš„åˆ™æ˜¯å›ºå®šåŸŸåï¼Œæ˜ å°„çš„å†…ç½‘åœ°å€ä¹Ÿå¯ä»¥éšæ—¶æ›´æ”¹ã€‚æ¥¼ä¸»ä»å…è´¹åˆ‡åˆ°ä»˜è´¹æ¨¡å¼ï¼Œä¸€ä¸ªæœˆçš„VIPä½¿ç”¨å¤§æ¦‚åå‡ å—é’±å§ã€‚

![03.png](https://upload-images.jianshu.io/upload_images/97180-9d17464b1e651c1d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

2.Token 

Tokenè‡ªå·±éšä¾¿å†™å°±è¡Œäº†ï¼Œä½†æ˜¯è¦è®°ä½å®ƒï¼Œå› ä¸ºä½ åœ¨æ¥å£ä¸­è¦ç”¨çš„ã€‚

3.EncodingAESKey

éšæœºç”Ÿæˆå³å¯ã€‚

4.åŠ å¯†æ–¹å¼å’Œæ•°æ®æ ¼å¼

æ ¹æ®è‡ªå·±å–œæ¬¢é€‰æ‹©ï¼Œæ¥¼ä¸»é€‰æ‹©çš„å®‰å…¨æ¨¡å¼å’ŒJSONæ ¼å¼ã€‚
ä¸åŒçš„æ¨¡å¼å’Œæ•°æ®æ ¼å¼ï¼Œåœ¨å¼€å‘ä¸Šä¼šæœ‰ä¸åŒï¼Œè‡ªå·±è¡¡é‡ã€‚
æ—¢ç„¶è¿™äº›é…ç½®éƒ½æ¸…æ¥šï¼Œé‚£å¼€å§‹ç ä»£ç ã€‚

#### éªŒè¯æ¶ˆæ¯çš„ç¡®æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨
é…ç½®æäº¤å‰ï¼Œéœ€è¦æŠŠéªŒè¯æ¶ˆæ¯æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨çš„æ¥å£å†™å¥½ã€‚

server.js 

```
    /*
     * https://developers.weixin.qq.com/miniprogram/dev/framework/server-ability/message-push.html
     * éªŒè¯æ¶ˆæ¯çš„ç¡®æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨
     * å¼€å‘è€…é€šè¿‡æ£€éªŒ signature å¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼ˆä¸‹é¢æœ‰æ ¡éªŒæ–¹å¼ï¼‰ã€‚
     * è‹¥ç¡®è®¤æ­¤æ¬¡ GET è¯·æ±‚æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨ï¼Œè¯·åŸæ ·è¿”å› echostr å‚æ•°å†…å®¹ï¼Œ
     * åˆ™æ¥å…¥ç”Ÿæ•ˆï¼Œæˆä¸ºå¼€å‘è€…æˆåŠŸï¼Œå¦åˆ™æ¥å…¥å¤±è´¥ã€‚åŠ å¯†/æ ¡éªŒæµç¨‹å¦‚ä¸‹ï¼š
     * å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº
     * å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†
     * å¼€å‘è€…è·å¾—åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸signatureå¯¹æ¯”ï¼Œæ ‡è¯†è¯¥è¯·æ±‚æ¥æºäºå¾®ä¿¡
     */
     const crypto = require('crypto');
     async wxCallbackAction(){
     	const ctx = this.ctx;
     	const method = ctx.method;
     	//å¾®ä¿¡æœåŠ¡å™¨ç­¾åéªŒè¯ï¼Œç¡®è®¤è¯·æ±‚æ¥è‡ªå¾®ä¿¡
     	if(method === 'GET') {
     		// 1.è·å–å¾®ä¿¡æœåŠ¡å™¨Getè¯·æ±‚çš„å‚æ•° signatureã€timestampã€nonceã€echostr
     		const {
     			signature,
     			timestamp,
     			nonce,
     			echostr
     		} = ctx.query;
     		
     		// 2.å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº
     		let array = ['yourToken', timestamp, nonce];
     		array.sort();
     		
     		// 3.å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†
     		const tempStr = array.join('');
     		const hashCode = crypto.createHash('sha1'); //åˆ›å»ºåŠ å¯†ç±»å‹
     		const resultCode = hashCode.update(tempStr, 'utf8').digest('hex');
     		
     		// 4.å¼€å‘è€…è·å¾—åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸signatureå¯¹æ¯”ï¼Œæ ‡è¯†è¯¥è¯·æ±‚æ¥æºäºå¾®ä¿¡
     		if (resultCode === signature) {
     			console.log('éªŒè¯æˆåŠŸï¼Œæ¶ˆæ¯æ˜¯ä»å¾®ä¿¡æœåŠ¡å™¨è½¬å‘è¿‡æ¥');
     			return this.json(echostr);
     		}else {
     			console.log('éªŒè¯å¤±è´¥ï¼ï¼ï¼');
     			return this.json({
     				status: -1,
     				message: "éªŒè¯å¤±è´¥"
     			});
     		}
            
     	}
     }
```

éªŒè¯æ¥å£å¼€å‘å®Œæ¯•ï¼Œåå°é…ç½®å¯ä»¥å»ç‚¹æäº¤äº†ã€‚é…ç½®æˆåŠŸä¼šæç¤ºå¦‚ä¸‹:


![04.png](https://upload-images.jianshu.io/upload_images/97180-82e7860b2436f628.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### æ¥æ”¶æ¶ˆæ¯å’Œæ¨é€æ¶ˆæ¯

> å½“ç”¨æˆ·åœ¨å®¢æœä¼šè¯å‘é€æ¶ˆæ¯ã€æˆ–ç”±æŸäº›ç‰¹å®šçš„ç”¨æˆ·æ“ä½œå¼•å‘äº‹ä»¶æ¨é€æ—¶ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå°†æ¶ˆæ¯æˆ–äº‹ä»¶çš„æ•°æ®åŒ…å‘é€åˆ°å¼€å‘è€…å¡«å†™çš„ URLã€‚å¼€å‘è€…æ”¶åˆ°è¯·æ±‚åå¯ä»¥ä½¿ç”¨Â [å‘é€å®¢æœæ¶ˆæ¯](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.send.html)Â æ¥å£è¿›è¡Œå¼‚æ­¥å›å¤ã€‚

æœ¬æ–‡ä»¥æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯ä¸ºä¾‹å¼€å‘:

server.js

```
	const WXDecryptContact = require('./WXDecryptContact');
	async wxCallbackAction(){
 		const ctx = this.ctx;
 		const method = ctx.method;
 		//æ¥æ”¶ä¿¡æ¯æ—¶ ä¸ºPOSTè¯·æ±‚ï¼›(å®Œæ•´ä»£ç è‡ªè¡Œä¸ä¸Šé¢éªŒè¯æ—¶çš„åˆå¹¶å³å¯)
 		if(method === 'POST'){
 			const { Encrypt } = ctx.request.body;
 			//é…ç½®æ—¶é€‰çš„å®‰å…¨æ¨¡å¼ å› æ­¤éœ€è¦è§£å¯†
 			if(!Encrypt){
 				return this.json('success');
 			}
 			const decryptData = WXDecryptContact(Encrypt);
 			await this._handleWxMsg(decryptData);
          return this.json('success');
 		}
 	}
 	
 	//å¤„ç†å¾®ä¿¡å›è°ƒæ¶ˆæ¯çš„æ€»å…¥å£ (åªå¤„ç†äº†æ–‡æœ¬ç±»å‹ï¼Œå…¶ä»–ç±»å‹è‡ªè¡Œæ·»åŠ )
    async _handleWxMsg(msgJson){
        if(!msgJson){
            return;
        }

        const { MsgType } = msgJson;
        const { MsgType } = msgJson;
        if(MsgType === 'text'){
            await this._sendTextMessage(msgJson);
        }
    }
 	
 	//å¾®ä¿¡æ–‡æœ¬ä¿¡æ¯å…³é”®å­—è‡ªåŠ¨å›å¤
 	async _sendTextMessage(msgJson){
 		//è·å–CMSå®¢æœå…³é”®è¯å›å¤é…ç½®
 		const result = await this.callService('cms.getDataByName', 'wxApplet.contact');
 		
 		let keyWordObj = result.data || {};
 	
 		//é»˜è®¤å›å¤default
 		let options = keyWordObj.default;
 		for(let key in keyWordObj){
 			//æŸ¥çœ‹æ˜¯å¦å‘½ä¸­é…ç½®çš„å…³é”®è¯
 			if(msgJson.Content === key){
 				//CMSé…ç½®é¡¹
 				options = keyWordObj[key];
 				}
 			}
 		}
 		
 		//è·å–access_token
 		const accessToken = await this._getAccessToken();
 		
 		/*
 		* å…ˆåˆ¤æ–­é…ç½®å›å¤çš„æ¶ˆæ¯ç±»å‹æ˜¯ä¸æ˜¯imageç±»å‹
 		* å¦‚æœæ˜¯ åˆ™éœ€è¦å…ˆé€šè¿‡ æ–°å¢ç´ ææ¥å£ ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶è·å¾— media_id
 		*/
 		
 		let media_id = '';
 		if(options.type === 'image'){
 			//è·å–å›¾ç‰‡åœ°å€(ç›¸å¯¹è·¯å¾„)
 			let url = options.url;
 			const file = fs.createReadStream(url);
 			
 			//è°ƒç”¨å¾®ä¿¡ uploadTempMediaæ¥å£ å…·ä½“å®ç°è§ service.js
 			const mediaResult = await this.callService('wxApplet.uploadTempMedia',
	 			{
	 				access_token: accessToken,
	 				type: 'image'
	 			},
	 			{
	 				media: file
	 			}
 			);
 			
 			if(mediaResult.status === 0){
 				media_id = mediaResult.data.media_id;
 			}else {
 				//å¦‚æœå›¾ç‰‡idè·å–å¤±è´¥ åˆ™æŒ‰é»˜è®¤å¤„ç†
 				options = keyWordObj.default;
 			}
 		}
 		
 		//å›å¤ä¿¡æ¯ç»™ç”¨æˆ·
 		const sendMsgResult = await this.callService('wxApplet.sendMessageToCustomer',
 			{
 				access_token: accessToken,
 				touser: msgJson.FromUserName,
 				msgtype: options.type || 'text',
 				text: {
 					content: options.description || '',
 				},
 				link: options.type === "link" ? 
 					{
 						title: options.title,
 						description: options.description,
 						url: options.url,
 						thumb_url: options.thumb_url
 					}
 					:
 					{},
 				image: {
 					media_id
 				}
 			}
 		);
 		
 	}
```

service.js

```
const request = require('request');


/*
* è·å–CMSå®¢æœå…³é”®è¯å›å¤é…ç½®
* è¿™ä¸ªæ¥å£åªæ˜¯ä¸ºäº†å›å»CMSé…ç½®çš„å­—æ®µå›å¤å…³é”®å­—é…ç½® è¿”å›çš„dataæ•°æ®ç»“æ„å¦‚ä¸‹
*/
async contact(){
	return {
		data: {
			"1": {
			    "type": "link",
			    "title": "ç‚¹å‡»ä¸‹è½½[****]APP",
			    "description": "æ³¨å†Œé¢†å–é¢†***å…ƒæ³¨å†Œçº¢åŒ…ç¤¼",
			    "url": "https://m.renrendai.com/mo/***.html",
			    "thumb_url": "https://m.we.com/***/test.png"
			  },
			  "2": {
			    "url": "http://m.renrendai.com/cms/****/test.jpg",
			    "type": "image"
			  },
			  "3": {
			    "url": "/cms/***/test02.png",
			    "type": "image"
			  },
			  "default": {
			    "type": "text",
			    "description": "å†è§"
			  }
		}
	}
}

/*
 * æŠŠåª’ä½“æ–‡ä»¶ä¸Šä¼ åˆ°å¾®ä¿¡æœåŠ¡å™¨ã€‚ç›®å‰ä»…æ”¯æŒå›¾ç‰‡ã€‚ç”¨äºå‘é€å®¢æœæ¶ˆæ¯æˆ–è¢«åŠ¨å›å¤ç”¨æˆ·æ¶ˆæ¯ã€‚
 * https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.uploadTempMedia.html
 */
 
 async uploadTempMedia(data,formData){
 	const url = `https://api.weixin.qq.com/cgi-bin/media/upload?access_token=${data.access_token}&type=${data.type}`;
 	return new Promise((resolve, reject) => {
 		request.post({url, formData: formData}, (err, response, body) => {
 			try{
 				const out = JSON.parse(body);
 				let result = {
 					data: out,
 					status: 0,
 					message: "ok"
 				}
 				
 				return resolve(result);
 			
 			}catch(err){
 				return reject({
 					status: -1,
 					message: err.message
 				});
 			}
 		});
 	}
 }
 
 /*
 * å‘é€å®¢æœæ¶ˆæ¯ç»™ç”¨æˆ·
 * https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.send.html
 */
 
 async sendMessageToCustomer(data){
 	const url = `https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=${data.access_token}`;
 	return new Promise((resolve, reject) => {
 		request.post({url, data}, (err, response, body) => {
 			...
 		});
 	}

 }
 
```

WXDecryptContact.js

[æ¶ˆæ¯åŠ å¯†è§£å¯†æ–‡æ¡£](https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419318479&token=&lang=zh_CN)

```
const crypto = require('crypto'); // åŠ å¯†æ¨¡å—

const decodePKCS7 = function (buff) {
    let pad = buff[buff.length - 1];
    if (pad < 1 || pad > 32) {
        pad = 0;
    }
    return buff.slice(0, buff.length - pad);
};

// å¾®ä¿¡è½¬å‘å®¢æœæ¶ˆæ¯è§£å¯†
const decryptContact = (key, iv, crypted) => {
    const aesCipher = crypto.createDecipheriv('aes-256-cbc', key, iv);
    aesCipher.setAutoPadding(false);
    let decipheredBuff = Buffer.concat([aesCipher.update(crypted, 'base64'), aesCipher.final()]);
    decipheredBuff = decodePKCS7(decipheredBuff);
    const lenNetOrderCorpid = decipheredBuff.slice(16);
    const msgLen = lenNetOrderCorpid.slice(0, 4).readUInt32BE(0);
    const result = lenNetOrderCorpid.slice(4, msgLen + 4).toString();
    return result;
};

// è§£å¯†å¾®ä¿¡è¿”å›ç»™é…ç½®çš„æ¶ˆæ¯æœåŠ¡å™¨çš„ä¿¡æ¯
const decryptWXContact = (wechatData) => {
    if(!wechatData){
        wechatData = '';
    }
    //EncodingAESKey ä¸ºåå°é…ç½®æ—¶éšæœºç”Ÿæˆçš„
    const key = Buffer.from(EncodingAESKey + '=', 'base64');
    const iv = key.slice(0, 16);
    const result = decryptContact(key, iv, wechatData);
    const decryptedResult = JSON.parse(result);
    console.log(decryptedResult);
    return decryptedResult;
};

module.exports = decryptWXContact;
```

å‘¼~ ä»£ç ç»ˆäºç å®Œï¼Œæ¥çœ‹çœ‹æ•ˆæœ:

![05.gif](https://upload-images.jianshu.io/upload_images/97180-cf96239c4ef7d2a4.gif?imageMogr2/auto-orient/strip)

#### æ€»ç»“

å¼€å‘å¹¶ä¸æ˜¯ä¸€å¸†é£é¡ºçš„ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›å€¼å¾—ç•™æ„çš„å‘ï¼Œå¼ºè°ƒä¸€ä¸‹:

* åå°é…ç½®URLåœ°å€ä¸€å®šå¤–ç½‘å¯è®¿é—®(å¯ä»¥é€šè¿‡å†…ç½‘ç©¿é€è§£å†³)
* æ–‡ä»¶ä¸Šä¼ æ¥å£`uploadTempMedia` `media`å‚æ•°è¦ç”¨ FormDataæ•°æ®æ ¼å¼ (ç”¨nodeçš„`request`åº“å¾ˆå®¹æ˜“å®ç°ã€‚`urllib`è¿™ä¸ªåº“æœ‰å‘æœ‰å‘ éƒ½æ˜¯æ³ªT_T)
* åˆ‡è®°æ¥æ”¶æ¶ˆæ¯ä¸è®ºæˆåŠŸå¤±è´¥éƒ½è¦è¿”å›`success`ï¼Œä¸ç„¶å³ä½¿æˆåŠŸæ¥æ”¶è¿”å›æ¶ˆæ¯ï¼Œæ—¥å¿—æ²¡æœ‰æŠ¥é”™çš„æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯å‡ºç°IOSæç¤ºè¯¥å°ç¨‹åºæä¾›çš„æœåŠ¡å‡ºç°æ•…éšœ è¯·ç¨åå†è¯•ã€‚


#### å‚è€ƒèµ„æ–™

[koaæ¥å…¥å¾®ä¿¡å°ç¨‹åºå®¢æœæ¶ˆæ¯](https://www.jianshu.com/p/b40c57a0dfd0)

[requestæ–‡æ¡£](https://github.com/request/request#readme)